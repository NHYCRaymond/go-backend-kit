# Venue API 行为分析文档

## API端点
`https://wx.dududing.com/VenueMassige/sitedata`

## 重要发现

经过系统测试，我们发现了API的实际行为与预期的差异：

### 1. `week`参数被完全忽略

**测试结果**：
- 无论是否提供`week`参数，API返回完全相同的响应
- `week`参数的内容不影响响应结果
- API会在响应中自动生成`week`数组，与请求参数无关

**证据**：
```
测试日期: 2025-08-19
带week参数响应哈希: cfd1294426013e58a284bea45baf3456
不带week参数响应哈希: cfd1294426013e58a284bea45baf3456
结果: 完全相同
```

### 2. `date`参数完全控制返回数据

**测试结果**：
- 不同的`date`参数返回不同的场地预订数据
- 可以查询未来日期（测试到8月25日均正常）
- 每个日期的预订状态不同，符合真实场景

**测试数据**：
| 日期 | 已预订数量 | 响应大小 | 响应哈希（前8位） |
|------|------------|----------|-------------------|
| 2025-08-18 | 97 | 27118 bytes | e5d2ff50 |
| 2025-08-19 | 48 | 27004 bytes | cfd12944 |
| 2025-08-20 | 44 | 26675 bytes | 21bbb15e |
| 2025-08-22 | 24 | 26315 bytes | 999b9af9 |
| 2025-08-23 | 55 | 26822 bytes | 36ff6839 |
| 2025-08-24 | 48 | 26562 bytes | 841987f4 |
| 2025-08-25 | 0 | 26184 bytes | 296cb900 |

### 3. 响应中缺少日期标识

**问题**：
- API响应中没有包含请求的`date`参数
- 无法从响应内容判断数据对应哪一天
- 必须依赖请求上下文来标识数据日期

## 简化后的请求格式

### 必需参数
```
vid=1557                                    # 场地ID
pid=18                                      # 产品ID
openid=o_PUd7UvwOKaxG8AHYDo6X962bvg       # 用户OpenID
```

### 可选参数
```
date=2025-08-19                            # 查询特定日期（不提供则返回今天）
```

### 示例请求

**初始请求（获取今天的数据）**：
```bash
curl -X POST https://wx.dududing.com/VenueMassige/sitedata \
  -d "vid=1557&pid=18&openid=o_PUd7UvwOKaxG8AHYDo6X962bvg"
```

**查询特定日期**：
```bash
curl -X POST https://wx.dududing.com/VenueMassige/sitedata \
  -d "vid=1557&pid=18&date=2025-08-20&openid=o_PUd7UvwOKaxG8AHYDo6X962bvg"
```

## 响应结构

```json
{
    "vn_id": "1557",                       // 场地ID
    "week": [...],                         // API自动生成的week数组
    "times": [...],                        // 时间段列表
    "site_data": {                         // 场地预订数据
        "12": [...],                       // 6:00-7:00时段
        "14": [...],                       // 7:00-8:00时段
        ...
    },
    "sites_name": [                        // 场地名称列表
        "网球1号",
        "网球2号",
        ...
    ]
}
```

## 对爬虫系统的影响

### 1. 简化任务配置
- 移除`week`参数的生成和传递
- 减少请求体大小
- 简化Lua脚本逻辑

### 2. 数据存储注意事项
- 必须在存储时记录请求的`date`参数
- 不能依赖响应内容判断日期
- 建议在任务元数据中保存date信息

### 3. 子任务生成策略
- 初始请求（不带date）获取今天数据和可用日期列表
- 根据返回的week数组生成子任务
- 每个子任务只需要指定date参数

## 优化建议

1. **请求优化**：
   - 移除冗余的`week`参数
   - 减少约30%的请求体大小

2. **代码简化**：
   - 删除week数组生成函数
   - 简化请求构建逻辑
   - 减少代码复杂度

3. **错误处理**：
   - 注意8月25日返回0个预订可能是正常情况
   - 需要区分"未开放预订"和"请求失败"

## 测试脚本

所有测试脚本位于：
- `test_venue_api_dates.go` - 测试不同日期的响应
- `test_venue_without_week.go` - 测试week参数的影响
- `test_future_dates.go` - 测试未来日期的支持

## 更新历史

- 2025-08-18: 初始测试发现week参数被忽略
- 2025-08-18: 确认date参数完全控制返回数据
- 2025-08-18: 创建简化版Lua脚本和助手函数